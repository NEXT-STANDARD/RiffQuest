# RiffQuest PoC（概念実証）

このディレクトリには、RiffQuest の技術検証用のプロトタイプコードが含まれています。

## 📋 PoC 一覧

### 1️⃣ OBS WebSocket v5 接続テスト
**ファイル:** `obs-test.js`

**目的:**
- OBS WebSocket v5 への接続確認
- 現在のシーン名を取得
- シーン変更イベントの監視
- `Practice_*` シーンの検出

**実行前の準備:**
1. OBS を起動
2. ツール → WebSocket サーバー設定 → サーバーを有効化
3. ポート 4455（デフォルト）を確認
4. パスワードを設定（または無効化）
5. `obs-test.js` の `OBS_CONFIG.password` を編集（必要に応じて）

**実行方法:**
```bash
node obs-test.js
```

**期待される出力:**
```
🚀 OBS WebSocket v5 接続テスト開始
接続先: ws://127.0.0.1:4455
---
1️⃣  OBS へ接続中...
✅ OBS に接続しました

2️⃣  OBS バージョン情報:
   OBS Studio: 30.0.0
   WebSocket: 5.3.0

3️⃣  現在のシーン名を取得:
   現在のシーン: "Practice_AltPicking"
   Practice シーン: ✅ はい

4️⃣  全シーン一覧:
   🎸 1. Practice_AltPicking
   🎸 2. Practice_Sweep
      3. Scene
      4. Chatting

5️⃣  シーン変更イベントの監視を開始...
   (シーンを切り替えて動作を確認してください)
   (Ctrl+C で終了)
---

6️⃣  音声入力ソース一覧:
   1. Guitar In (wasapi_input_capture)
   2. Mic/Aux (wasapi_input_capture)
```

**検証項目:**
- [x] OBS に接続できるか
- [x] シーン名を取得できるか
- [x] `Practice_*` シーンを判定できるか
- [x] シーン変更イベントを受信できるか
- [x] 音声入力ソースを一覧できるか

---

### 2️⃣ WebSocket サーバーのプロトタイプ
**ファイル:** `websocket-server-test.js`

**目的:**
- WebSocket サーバーの動作確認
- クライアント（Overlay）へのリアルタイムデータプッシュ
- 1秒ごとの更新イベント送信

**実行方法:**
```bash
node websocket-server-test.js
```

**期待される出力:**
```
🚀 WebSocket サーバー起動
📍 http://127.0.0.1:3030
---
ブラウザで http://127.0.0.1:3030 を開いてください
Ctrl+C で終了
```

**ブラウザで確認:**
1. ブラウザで `http://127.0.0.1:3030` を開く
2. WebSocket 接続が確立される
3. 1秒ごとにフォーカス時間・XP が更新される
4. 10秒ごとに PB 更新イベントが発生し、フラッシュアニメーションが表示される

**検証項目:**
- [x] WebSocket サーバーが起動するか
- [x] クライアントが接続できるか
- [x] リアルタイムでデータが更新されるか（1秒間隔）
- [x] レイテンシが 100ms 以内か
- [x] イベント駆動型の更新が機能するか（PB更新、クエスト達成）

---

### 3️⃣ FFT による BPM 自動検出の精度検証
**ファイル:** `bpm-detection-test.html`, `bpm-auto-calibration.html`

**目的:**
- メトロノーム音から BPM を推定するアルゴリズムの検証
- AG03 オーディオインターフェース向けの自動キャリブレーション
- Web Audio API を使った実装

**実行方法（通常版）:**
1. メトロノームアプリを起動（例: 120 BPM）
2. ブラウザで `bpm-detection-test.html` を開く
3. マイク権限を許可（AG03 を選択）
4. "BPM 検出開始" ボタンをクリック
5. 検出感度スライダーで閾値を調整（AG03: 0.015-0.025 推奨）
6. リアルタイムで BPM が表示される

**実行方法（キャリブレーション版）:**
1. ブラウザで `bpm-auto-calibration.html` を開く
2. **Step 1:** 静かな環境で「ノイズ測定開始」(5秒間)
3. **Step 2:** メトロノーム（120 BPM）を起動して「シグナル測定開始」(10秒間)
4. **Step 3:** 「閾値を計算」をクリック
5. 推奨閾値が自動計算される
6. 「BPM 検出をテスト」で値をコピーして通常版で使用

**検証項目:**
- [x] 精度: ±2 BPM 以内（40, 120, 130 BPM で確認済み）
- [x] 速度: リアルタイムで検出可能
- [x] 範囲: 40-240 BPM をカバー
- [x] AG03 対応: 自動キャリブレーション機能

**AG03 最適設定:**
- 推奨閾値: 0.015-0.025（自動キャリブレーションで最適化）
- AG03 入力ゲイン: LEDメーターが緑色に点灯する程度
- コンプレッサー: OFF

---

## 📊 検証結果サマリー

### ✅ PoC 1: OBS WebSocket v5 接続
- **結果**: 完全成功
- **環境**: OBS Studio 32.0.1, WebSocket 5.6.3, macOS
- **検証項目**:
  - ✅ OBS への接続成功
  - ✅ シーン名取得・`Practice_*` 判定
  - ✅ シーン変更イベントのリアルタイム監視
  - ✅ 音声入力ソース検出 (マイク, macOS 音声キャプチャ)
- **結論**: 本番実装に問題なし

### ✅ PoC 2: WebSocket サーバー
- **結果**: 完全成功
- **検証項目**:
  - ✅ WebSocket サーバー起動
  - ✅ クライアント接続・切断処理
  - ✅ リアルタイムデータ更新（1秒間隔、レイテンシ < 100ms）
  - ✅ イベント駆動型更新（PB更新、クエスト達成）
  - ✅ ポモドーロタイマーのカウントダウン
- **結論**: 本番実装に問題なし

### ✅ PoC 3: BPM 自動検出
- **結果**: 成功（AG03 対応版完成）
- **検証済み BPM**: 40, 120, 130 BPM（すべて ±2 BPM 以内）
- **検証項目**:
  - ✅ メトロノーム音からの BPM 推定
  - ✅ リアルタイム検出
  - ✅ 40-240 BPM の範囲をカバー
  - ✅ AG03 オーディオインターフェース対応
  - ✅ 自動キャリブレーション機能
- **重要な発見**:
  - **AG03（外部IF）**: 推奨閾値 0.015-0.025
  - **内蔵マイク**: 推奨閾値 0.05-0.10
  - デバイスごとの自動キャリブレーション機能を実装
- **実装済みファイル**:
  - `bpm-detection-test.html` - BPM検出（手動閾値調整）
  - `bpm-auto-calibration.html` - 自動キャリブレーションツール
- **結論**: 基本機能は動作完了、本番実装準備完了

---

## 🚀 次のステップ

**全PoC検証完了！本番実装フェーズへ移行**

### Phase 1: プロジェクトセットアップ (Week 1-2)
1. **Electron プロジェクトのセットアップ**
   - TypeScript + Vite + React の環境構築
   - PoC コードを統合
   - ディレクトリ構造の設計

2. **SQLite 統合**
   - WAL モード有効化
   - マイグレーションシステムの構築
   - データモデルの実装

3. **開発環境の整備**
   - ESLint/Prettier 設定
   - Git フロー確立
   - CI/CD パイプライン検討

### Phase 2: Sprint 1 開始 (Week 3-4)
- OBS 接続/セッション管理/フォーカス計測/Overlay最小実装
- PoC で検証した機能の統合

---

## 📝 PoC で学んだこと

### 成功ポイント
- ✅ OBS WebSocket v5 は非常に安定している
- ✅ WebSocket のレイテンシは十分低い（< 100ms、目標達成）
- ✅ BPM 検出は AG03 で正確に動作（自動キャリブレーション必須）
- ✅ すべての主要機能が技術的に実現可能

### 技術的な発見
- **AG03 オーディオIF**: 低ノイズのため閾値 0.015-0.025 が最適
- **自動キャリブレーション**: SNR ベースの閾値計算が有効
- **リアルタイム更新**: WebSocket プッシュで十分なパフォーマンス
- **シーン判定**: `Practice_` プレフィックスで柔軟に対応可能

### 本番実装時の注意点
1. **BPM 検出**: デバイスごとの自動キャリブレーション機能を組み込む
2. **エラーハンドリング**: OBS 切断時の再接続ロジック
3. **パフォーマンス**: CPU 使用率の継続的なモニタリング
4. **UX**: 初回セットアップの簡素化（ウィザード形式）

### 次回検証が必要な項目（Sprint 2 以降）
- MIDI 入力の動作確認と Learn 機能
- Twitch/YouTube チャット統合
- SQLite のパフォーマンス（大量データ時）
- Overlay のテーマ切替とアニメーション最適化
