<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RiffQuest BPM æ¤œå‡ºãƒ†ã‚¹ãƒˆ v3 (AG03å¯¾å¿œ)</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 900px;
      margin: 50px auto;
      padding: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }

    h1 {
      text-align: center;
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .subtitle {
      text-align: center;
      opacity: 0.9;
      margin-bottom: 40px;
    }

    .container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .bpm-display {
      text-align: center;
      font-size: 6em;
      font-weight: bold;
      margin: 40px 0;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }

    .bpm-label {
      text-align: center;
      font-size: 1.2em;
      opacity: 0.8;
      margin-bottom: 20px;
    }

    .status {
      text-align: center;
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .status.idle {
      background: rgba(255, 255, 255, 0.2);
    }

    .status.listening {
      background: rgba(81, 207, 102, 0.3);
      animation: pulse 2s infinite;
    }

    .status.error {
      background: rgba(255, 107, 107, 0.3);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .controls {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin: 30px 0;
      flex-wrap: wrap;
    }

    button {
      padding: 15px 40px;
      font-size: 1.1em;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    .btn-start {
      background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
      color: white;
    }

    .btn-stop {
      background: linear-gradient(135deg, #ff6b6b 0%, #fa5252 100%);
      color: white;
    }

    .btn-stop:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .threshold-control {
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
    }

    .threshold-control label {
      display: block;
      margin-bottom: 10px;
    }

    .threshold-control input[type="range"] {
      width: 100%;
      height: 8px;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.3);
      outline: none;
    }

    .threshold-value {
      text-align: center;
      font-size: 1.5em;
      font-weight: bold;
      margin-top: 10px;
    }

    .waveform {
      width: 100%;
      height: 150px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      margin: 20px 0;
    }

    .debug {
      background: rgba(0, 0, 0, 0.5);
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      max-height: 300px;
      overflow-y: auto;
    }

    .debug-line {
      margin: 5px 0;
      color: #51cf66;
    }

    .debug-line.warning {
      color: #ffd700;
    }

    .debug-line.error {
      color: #ff6b6b;
    }

    .accuracy {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
      margin-top: 20px;
    }

    .accuracy-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }

    .accuracy-label {
      opacity: 0.8;
      font-size: 0.9em;
    }

    .accuracy-value {
      font-size: 1.5em;
      font-weight: bold;
      margin-top: 5px;
    }

    .info {
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
      margin-top: 30px;
    }

    .info h3 {
      margin-top: 0;
    }

    .info ul {
      margin: 10px 0;
      padding-left: 20px;
    }

    .info li {
      margin: 8px 0;
    }

    .peak-indicator {
      width: 100%;
      height: 40px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      margin: 10px 0;
      position: relative;
      overflow: hidden;
    }

    .peak-bar {
      height: 100%;
      background: linear-gradient(90deg, #51cf66 0%, #ffd700 50%, #ff6b6b 100%);
      width: 0%;
      transition: width 0.1s;
    }

    .threshold-line {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #fff;
      box-shadow: 0 0 10px #fff;
    }
  </style>
</head>
<body>
  <h1>ğŸ¸ RiffQuest BPM æ¤œå‡ºãƒ†ã‚¹ãƒˆ v3</h1>
  <p class="subtitle">AG03 ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å¯¾å¿œç‰ˆ</p>

  <div class="container">
    <div class="bpm-label">æ¨å®š BPM</div>
    <div class="bpm-display" id="bpm-display">---</div>

    <div class="status idle" id="status">
      æº–å‚™å®Œäº† - ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ ã‚’èµ·å‹•ã—ã¦ãã ã•ã„
    </div>

    <div class="threshold-control">
      <label for="threshold-slider">æ¤œå‡ºæ„Ÿåº¦ (é–¾å€¤èª¿æ•´)</label>
      <input type="range" id="threshold-slider" min="0.001" max="0.5" step="0.001" value="0.05">
      <div class="threshold-value">é–¾å€¤: <span id="threshold-value">0.050</span></div>
      <p style="font-size: 0.9em; opacity: 0.8; margin-top: 10px;">
        ğŸ’¡ ãƒ“ãƒ¼ãƒˆãŒæ¤œå‡ºã•ã‚Œãªã„å ´åˆã¯ã€ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å·¦ã«å‹•ã‹ã—ã¦æ„Ÿåº¦ã‚’ä¸Šã’ã¦ãã ã•ã„
      </p>
    </div>

    <div class="peak-indicator">
      <div class="peak-bar" id="peak-bar"></div>
      <div class="threshold-line" id="threshold-line"></div>
    </div>

    <canvas id="waveform" class="waveform"></canvas>

    <div class="controls">
      <button class="btn-start" id="start-btn">ğŸµ BPM æ¤œå‡ºé–‹å§‹</button>
      <button class="btn-stop" id="stop-btn" disabled>â¹ï¸ åœæ­¢</button>
    </div>

    <div class="accuracy">
      <div class="accuracy-item">
        <div class="accuracy-label">çµŒéæ™‚é–“</div>
        <div class="accuracy-value" id="sample-time">0.0s</div>
      </div>
      <div class="accuracy-item">
        <div class="accuracy-label">æ¤œå‡ºæ•°</div>
        <div class="accuracy-value" id="detect-count">0</div>
      </div>
      <div class="accuracy-item">
        <div class="accuracy-label">ç¾åœ¨RMS</div>
        <div class="accuracy-value" id="current-rms">0.000</div>
      </div>
    </div>

    <div class="debug" id="debug">
      <div class="debug-line">ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</div>
    </div>

    <div class="info">
      <h3>ğŸ“ ä½¿ç”¨æ–¹æ³•ï¼ˆAG03 å‘ã‘ï¼‰</h3>
      <ul>
        <li>ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ï¼ˆ120 BPM æ¨å¥¨ï¼‰</li>
        <li>AG03 ã®å…¥åŠ›ãƒ¬ãƒ™ãƒ«ã‚’èª¿æ•´ï¼ˆLEDãƒ¡ãƒ¼ã‚¿ãƒ¼ãŒæŒ¯ã‚Œã‚‹ç¨‹åº¦ï¼‰</li>
        <li>ãƒã‚¤ã‚¯é¸æŠã§ AG03 ã‚’é¸æŠ</li>
        <li>"BPM æ¤œå‡ºé–‹å§‹" ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
        <li>ãƒ”ãƒ¼ã‚¯ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ï¼ˆç·‘ã®ãƒãƒ¼ï¼‰ãŒå‹•ã„ã¦ã„ã‚‹ã‹ç¢ºèª</li>
        <li>ãƒ“ãƒ¼ãƒˆãŒæ¤œå‡ºã•ã‚Œãªã„å ´åˆã¯ã€Œæ¤œå‡ºæ„Ÿåº¦ã€ã‚’èª¿æ•´</li>
      </ul>

      <h3>ğŸ¯ ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®è¦‹æ–¹</h3>
      <ul>
        <li><strong>ç¾åœ¨RMS:</strong> éŸ³ã®å¼·ã•ï¼ˆ0.05 ä»¥ä¸ŠãŒç†æƒ³ï¼‰</li>
        <li><strong>ãƒ”ãƒ¼ã‚¯ãƒãƒ¼:</strong> ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®éŸ³é‡ï¼ˆç·‘ãƒãƒ¼ãŒé–¾å€¤ã‚’è¶…ãˆã‚‹ã¨ãƒ“ãƒ¼ãƒˆæ¤œå‡ºï¼‰</li>
        <li><strong>æ¤œå‡ºæ•°:</strong> ãƒ“ãƒ¼ãƒˆã‚’æ¤œå‡ºã—ãŸå›æ•°ï¼ˆå¢—ãˆã¦ã„ã‚Œã°æ­£å¸¸ï¼‰</li>
      </ul>
    </div>
  </div>

  <script>
    let audioContext = null;
    let analyser = null;
    let microphone = null;
    let animationId = null;
    let isDetecting = false;
    let beatTimestamps = [];
    let bpmHistory = [];
    let startTime = null;
    let detectionCount = 0;
    let threshold = 0.05;

    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const bpmDisplay = document.getElementById('bpm-display');
    const statusEl = document.getElementById('status');
    const sampleTimeEl = document.getElementById('sample-time');
    const detectCountEl = document.getElementById('detect-count');
    const currentRmsEl = document.getElementById('current-rms');
    const debugEl = document.getElementById('debug');
    const canvas = document.getElementById('waveform');
    const canvasCtx = canvas.getContext('2d');
    const thresholdSlider = document.getElementById('threshold-slider');
    const thresholdValueEl = document.getElementById('threshold-value');
    const peakBar = document.getElementById('peak-bar');
    const thresholdLine = document.getElementById('threshold-line');

    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;

    // é–¾å€¤ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    thresholdSlider.addEventListener('input', (e) => {
      threshold = parseFloat(e.target.value);
      thresholdValueEl.textContent = threshold.toFixed(3);
      updateThresholdLine();
      if (isDetecting) {
        addDebug(`é–¾å€¤ã‚’ ${threshold.toFixed(3)} ã«å¤‰æ›´`, 'warning');
      }
    });

    function updateThresholdLine() {
      const percent = (threshold / 0.5) * 100;
      thresholdLine.style.left = percent + '%';
    }

    updateThresholdLine();

    startBtn.addEventListener('click', startDetection);
    stopBtn.addEventListener('click', stopDetection);

    function addDebug(message, type = 'normal') {
      const line = document.createElement('div');
      line.className = 'debug-line';
      if (type === 'warning') line.classList.add('warning');
      if (type === 'error') line.classList.add('error');

      const time = new Date().toLocaleTimeString('ja-JP');
      line.textContent = `[${time}] ${message}`;
      debugEl.insertBefore(line, debugEl.firstChild);

      while (debugEl.children.length > 50) {
        debugEl.removeChild(debugEl.lastChild);
      }
    }

    async function startDetection() {
      try {
        statusEl.textContent = 'ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¦æ±‚ä¸­...';
        statusEl.className = 'status idle';
        addDebug('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¦æ±‚ä¸­...');

        const stream = await navigator.mediaDevices.getUserMedia({
          audio: {
            echoCancellation: false,
            noiseSuppression: false,
            autoGainControl: false,
            sampleRate: 44100
          }
        });

        addDebug('âœ… ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ (AG03)');

        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 4096; // ã‚ˆã‚Šç²¾å¯†ãªè§£æ
        analyser.smoothingTimeConstant = 0.3;

        microphone = audioContext.createMediaStreamSource(stream);
        microphone.connect(analyser);

        addDebug(`AudioContext ä½œæˆ: ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆ ${audioContext.sampleRate}Hz`);
        addDebug(`FFT ã‚µã‚¤ã‚º: ${analyser.fftSize}`);
        addDebug(`åˆæœŸé–¾å€¤: ${threshold.toFixed(3)}`);

        isDetecting = true;
        beatTimestamps = [];
        bpmHistory = [];
        startTime = Date.now();
        detectionCount = 0;

        startBtn.disabled = true;
        stopBtn.disabled = false;

        statusEl.textContent = 'ğŸ§ BPM ã‚’æ¤œå‡ºä¸­... (æ„Ÿåº¦ã‚’èª¿æ•´ã—ã¦ãã ã•ã„)';
        statusEl.className = 'status listening';
        addDebug('æ¤œå‡ºé–‹å§‹ - ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ ã‚’é³´ã‚‰ã—ã¦ãã ã•ã„');

        detect();

      } catch (error) {
        statusEl.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
        statusEl.className = 'status error';
        addDebug('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        console.error('Error:', error);
      }
    }

    function stopDetection() {
      isDetecting = false;

      if (microphone) {
        microphone.disconnect();
        microphone = null;
      }

      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }

      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }

      startBtn.disabled = false;
      stopBtn.disabled = true;

      statusEl.textContent = 'åœæ­¢ã—ã¾ã—ãŸ';
      statusEl.className = 'status idle';
      addDebug('æ¤œå‡ºåœæ­¢');
    }

    let lastBeatTime = 0;
    const MIN_BEAT_INTERVAL = 250; // æœ€å°ãƒ“ãƒ¼ãƒˆé–“éš”ï¼ˆmsï¼‰= 240 BPM

    function detect() {
      if (!isDetecting) return;

      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      analyser.getByteTimeDomainData(dataArray);

      // æ³¢å½¢æç”»
      drawWaveform(dataArray, bufferLength);

      // RMSè¨ˆç®—
      let sum = 0;
      for (let i = 0; i < bufferLength; i++) {
        const normalized = (dataArray[i] - 128) / 128.0;
        sum += normalized * normalized;
      }
      const rms = Math.sqrt(sum / bufferLength);
      currentRmsEl.textContent = rms.toFixed(3);

      // ãƒ”ãƒ¼ã‚¯ãƒãƒ¼æ›´æ–°
      const peakPercent = Math.min(100, (rms / 0.5) * 100);
      peakBar.style.width = peakPercent + '%';

      // ãƒ“ãƒ¼ãƒˆæ¤œå‡º
      const now = Date.now();

      if (rms > threshold && (now - lastBeatTime) > MIN_BEAT_INTERVAL) {
        beatTimestamps.push(now);
        lastBeatTime = now;
        detectionCount++;
        detectCountEl.textContent = detectionCount;
        addDebug(`ğŸµ ãƒ“ãƒ¼ãƒˆæ¤œå‡º! RMS: ${rms.toFixed(3)} > é–¾å€¤: ${threshold.toFixed(3)}`);

        // BPMè¨ˆç®—ï¼ˆæœ€å¾Œã®3ã€œ10ãƒ“ãƒ¼ãƒˆã‚’ä½¿ç”¨ï¼‰
        if (beatTimestamps.length >= 3) {
          const recentBeats = beatTimestamps.slice(-10);
          const intervals = [];

          for (let i = 1; i < recentBeats.length; i++) {
            intervals.push(recentBeats[i] - recentBeats[i - 1]);
          }

          const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
          const bpm = Math.round(60000 / avgInterval);

          if (bpm >= 40 && bpm <= 240) {
            bpmHistory.push(bpm);
            addDebug(`è¨ˆç®—: å¹³å‡é–“éš” ${Math.round(avgInterval)}ms â†’ ${bpm} BPM`);

            // æœ€æ–°10ã‚µãƒ³ãƒ—ãƒ«ã®ä¸­å¤®å€¤ã‚’ä½¿ç”¨ï¼ˆå¤–ã‚Œå€¤ã«å¼·ã„ï¼‰
            const recentBPMs = bpmHistory.slice(-10);
            const sortedBPMs = [...recentBPMs].sort((a, b) => a - b);
            const medianBPM = sortedBPMs[Math.floor(sortedBPMs.length / 2)];

            bpmDisplay.textContent = medianBPM;
            addDebug(`âœ… ä¸­å¤®å€¤ BPM: ${medianBPM} (ã‚µãƒ³ãƒ—ãƒ«æ•°: ${recentBPMs.length})`);
          } else {
            addDebug(`âš ï¸ BPM ãŒç¯„å›²å¤–: ${bpm} (40-240 BPM ã®ç¯„å›²å†…ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™)`, 'warning');
          }
        }

        // å¤ã„ãƒ“ãƒ¼ãƒˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å‰Šé™¤ï¼ˆ15ç§’ä»¥ä¸Šå‰ï¼‰
        beatTimestamps = beatTimestamps.filter(ts => (now - ts) < 15000);
      }

      // çµŒéæ™‚é–“ã‚’æ›´æ–°
      const elapsedTime = (Date.now() - startTime) / 1000;
      sampleTimeEl.textContent = elapsedTime.toFixed(1) + 's';

      animationId = requestAnimationFrame(detect);
    }

    function drawWaveform(dataArray, bufferLength) {
      canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.2)';
      canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

      canvasCtx.lineWidth = 2;
      canvasCtx.strokeStyle = '#51cf66';
      canvasCtx.beginPath();

      const sliceWidth = canvas.width / bufferLength;
      let x = 0;

      for (let i = 0; i < bufferLength; i++) {
        const v = dataArray[i] / 128.0;
        const y = (v * canvas.height) / 2;

        if (i === 0) {
          canvasCtx.moveTo(x, y);
        } else {
          canvasCtx.lineTo(x, y);
        }

        x += sliceWidth;
      }

      canvasCtx.lineTo(canvas.width, canvas.height / 2);
      canvasCtx.stroke();
    }
  </script>
</body>
</html>
