/**
 * RiffQuest Server
 * Express + Socket.io + OBS WebSocketçµ±åˆ
 */

import express from 'express';
import { createServer } from 'http';
import { Server } from 'socket.io';
import cors from 'cors';
import OBSWebSocket from 'obs-websocket-js';

const app = express();
const httpServer = createServer(app);
const io = new Server(httpServer, {
  cors: {
    origin: 'http://localhost:5173',
    methods: ['GET', 'POST'],
  },
});

const obs = new OBSWebSocket();
let obsConnected = false;

// ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
app.use(cors());
app.use(express.json());

// OBS WebSocketã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
obs.on('CurrentProgramSceneChanged', (data) => {
  console.log('[OBS] ã‚·ãƒ¼ãƒ³å¤‰æ›´:', data.sceneName);
  io.emit('obs:scene-changed', data.sceneName);
});

obs.on('ConnectionClosed', () => {
  console.log('[OBS] æŽ¥ç¶šãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸ');
  obsConnected = false;
  io.emit('obs:disconnected');
});

obs.on('ConnectionError', (error) => {
  console.error('[OBS] æŽ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
  obsConnected = false;
  io.emit('obs:error', { message: error.message });
});

// REST API
app.get('/api/health', (_req, res) => {
  res.json({
    status: 'ok',
    obs: obsConnected ? 'connected' : 'disconnected',
  });
});

app.post('/api/obs/connect', async (_req, res) => {
  const { url, password } = _req.body;

  try {
    await obs.connect(url, password);
    obsConnected = true;
    console.log('[OBS] æŽ¥ç¶šæˆåŠŸ:', url);

    io.emit('obs:connected', { url });

    res.json({ success: true });
  } catch (error: any) {
    console.error('[OBS] æŽ¥ç¶šå¤±æ•—:', error);
    res.status(500).json({
      success: false,
      error: error.message,
    });
  }
});

app.post('/api/obs/disconnect', async (_req, res) => {
  try {
    await obs.disconnect();
    obsConnected = false;
    console.log('[OBS] åˆ‡æ–­ã—ã¾ã—ãŸ');

    io.emit('obs:disconnected');

    res.json({ success: true });
  } catch (error: any) {
    res.status(500).json({
      success: false,
      error: error.message,
    });
  }
});

app.get('/api/obs/current-scene', async (_req, res) => {
  try {
    if (!obsConnected) {
      throw new Error('OBSã«æŽ¥ç¶šã—ã¦ã„ã¾ã›ã‚“');
    }

    const response = await obs.call('GetCurrentProgramScene');
    res.json({
      success: true,
      sceneName: response.currentProgramSceneName || '',
    });
  } catch (error: any) {
    res.status(500).json({
      success: false,
      error: error.message,
    });
  }
});

// Socket.ioæŽ¥ç¶šå‡¦ç†
io.on('connection', (socket) => {
  console.log('[Socket.io] ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæŽ¥ç¶š:', socket.id);

  // OBSæŽ¥ç¶šçŠ¶æ…‹ã‚’é€ä¿¡
  socket.emit('obs:status', { connected: obsConnected });

  socket.on('disconnect', () => {
    console.log('[Socket.io] ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆ‡æ–­:', socket.id);
  });
});

// ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
const PORT = process.env.PORT || 3030;
httpServer.listen(PORT, () => {
  console.log(`\nðŸš€ RiffQuest Server running on http://localhost:${PORT}`);
  console.log(`ðŸ“¡ Socket.io ready for connections`);
  console.log(`ðŸŽ¸ Ready to connect to OBS Studio\n`);
});
